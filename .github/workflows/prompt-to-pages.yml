- name: Build site
  shell: bash
  run: |
    set -e
    # 1) Make sure dist/ exists
    mkdir -p dist

    # 2) Pick the generator script you actually have
    PROMPT="${{ steps.derive.outputs.prompt }}"
    SCRIPT="scripts/generate_site.js"
    if [ ! -f "$SCRIPT" ] && [ -f "scripts/generate_site-3.js" ]; then
      SCRIPT="scripts/generate_site-3.js"
    fi

    # 3) Run the generator (with or without prompt)
    if [ -n "$PROMPT" ]; then
      echo "Running with prompt:"
      printf '%s\n' "$PROMPT"
      node "$SCRIPT" --prompt "$PROMPT"
    else
      echo "No prompt provided; building with default."
      node "$SCRIPT"
    fi

    # 4) Fallback homepage
    if [ ! -f dist/index.html ]; then
      if [ -f index.html ]; then
        cp index.html dist/index.html
      elif [ -f index-2.html ]; then
        cp index-2.html dist/index.html
      else
        echo "❌ No dist/index.html produced and no root index.html/index-2.html to copy." >&2
        exit 1
      fi
    fi

- name: Setup Pages
  uses: actions/configure-pages@v5

- name: Upload artifact
  uses: actions/upload-pages-artifact@v3
  with:
    path: dist

- name: Deploy to GitHub Pages
  id: deployment
  uses: actions/deploy-pages@v4
